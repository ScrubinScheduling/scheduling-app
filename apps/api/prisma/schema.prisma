generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                    @unique
  firstName               String?
  lastName                String?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  Shift                   Shift[]
  UserRoleMembership      UserRoleMembership[]
  UserWorkspaceMembership UserWorkspaceMembership[]
  ShiftRequests           ShiftRequest[]            @relation("RequestorRelation")
  timeOffRequests         TimeOffRequest[]
  meetingCreator          Meeting[]
}

model UserWorkspaceMembership {
  id          Int       @id @default(autoincrement())
  userId      String
  workspaceId Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  meetingInvites  MeetingInvite[]

  @@unique([workspaceId, userId])
}

model Workspace {
  id              Int                       @id @default(autoincrement())              
  name            String
  adminId         String
  location        String
  roleMemberships UserRoleMembership[]
  memberships     UserWorkspaceMembership[]
  shiftRequests   ShiftRequest[]
  timeOffRequests TimeOffRequest[]
  meetings        Meeting[]
}

model Shift {
  id             Int       @id @default(autoincrement())
  startTime      DateTime
  endTime        DateTime
  userId         String
  breakDuration  Int
  workspaceId    Int
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  timesheet Timesheet?

}

model Timesheet {
  id             Int       @id @default(autoincrement())
  shiftId        Int       @unique
  clockInTime    DateTime?
  clockOutTime   DateTime?
  startBreakTime DateTime?
  endBreakTime   DateTime?
  shift Shift @relation(fields: [shiftId], references: [id])

}
model Role {
  id                 Int                  @id @default(autoincrement())
  workspaceId        Int
  name               String
  permissions        Int                  @default(0)
  UserRoleMembership UserRoleMembership[]
}

model Permissions {
  bitkey      Int    @unique
  name        String
  description String
}

model UserRoleMembership {
  id          Int       @id @default(autoincrement())
  userId      String
  workSpaceId Int
  roleId      Int
  role        Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workSpaceId], references: [id], onDelete: Cascade)
}

model ShiftRequest {
  id               Int       @id @default(autoincrement())
  requestorId      String
  workspaceId      Int
  lendedShiftId    Int
  requestedShiftId Int?
  requestor        User      @relation("RequestorRelation", fields: [requestorId], references: [id], onDelete: Cascade)
  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lendedShift      Shift     @relation("Lended", fields: [lendedShiftId], references: [id], onDelete: Cascade)
  requestedShift   Shift?    @relation("Requested", fields: [requestedShiftId], references: [id])
  requestedUserId     String
  approvedByRequested ApprovalStatus  @default(PENDING)
  approvedByManager   ApprovalStatus  @default(PENDING)
}

model Invitation {
  id          String    @id @default(uuid())
  workspaceId Int
  expiresAt   DateTime? @default(dbgenerated("(now() + '1 day'::interval)")) @db.Timestamptz(6)
  acceptedAt  DateTime?
}

model TimeOffRequest {
  id          Int       @id @default(autoincrement())
  userId      String
  workspaceId Int
  startDate   DateTime
  endDate     DateTime
  status      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}



enum MeetingStatus {
  PENDING
  FINALIZED
  CANCELLED
  RESCHEDULED
}

enum MeetingResponse {
  PENDING
  YES
  NO
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model Meeting {
  id            Int             @id @default(autoincrement())
  workspaceId   Int
  createdById   String
  location      String
  description   String
  scheduledAt   DateTime
  status        MeetingStatus   @default(PENDING)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy     User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  invitations   MeetingInvite[]
}

model MeetingInvite {
  id           Int                     @id @default(autoincrement())
  meetingId    Int
  membershipId Int
  response     MeetingResponse         @default(PENDING)
  respondedAt  DateTime?

  meeting      Meeting                 @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  membership   UserWorkspaceMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@unique([meetingId, membershipId])
}